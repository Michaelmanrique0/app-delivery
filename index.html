<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<title>Gesti√≥n de Pedidos - Delivery App</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>

<body>
<div class="container">
  <h1>üöö Gesti√≥n de Pedidos Delivery</h1>

  <div class="section sync-section">
    <h2>üîÑ Sincronizar Datos</h2>
    <div class="sync-buttons">
      <button class="btn-sync" onclick="exportarDatos()">üì§ Exportar Datos</button>
      <button class="btn-sync" onclick="importarDatos()">üì• Importar Datos</button>
      <button class="btn-sync" onclick="mostrarQR()">üì± Mostrar QR</button>
    </div>
    <div class="sync-code-area" id="syncCodeArea" style="display: none;">
      <textarea id="syncData" placeholder="Pega aqu√≠ el c√≥digo de sincronizaci√≥n o escanea el QR..."></textarea>
      <button class="btn-primary" onclick="aplicarImportacion()" style="margin-top: 10px; width: 100%;">Aplicar Datos</button>
    </div>
    <div class="qr-container" id="qrContainer" style="display: none;">
      <h3>Escanea este c√≥digo QR con tu celular:</h3>
      <canvas id="qrCode"></canvas>
      <div class="sync-info">
        <strong>Instrucciones:</strong><br>
        1. En el PC: Haz clic en "Exportar Datos"<br>
        2. Copia el c√≥digo o escanea el QR<br>
        3. En el celular: Pega el c√≥digo y haz clic en "Aplicar Datos"
      </div>
    </div>
  </div>

  <div class="section">
    <h2>üìã Pegar Formato de Pedido</h2>
    <textarea id="textoPedido" placeholder="Pega aqu√≠ el formato del pedido..."></textarea>
    <br><br>
    <div class="map-url-input">
      <input type="text" id="mapUrlPedido" placeholder="URL de Google Maps para este pedido (obligatoria)" required>
    </div>
    <br>
    <button class="btn-primary" onclick="procesarPedido()">Procesar Pedido</button>
  </div>

  <div class="section">
    <div class="actions-bar">
      <h2 style="margin: 0; border: none; padding: 0;">üì¶ Lista de Pedidos</h2>
      <button class="btn-danger" onclick="eliminarTodos()">üóëÔ∏è Eliminar Todos</button>
    </div>
    <div class="total-recogido" id="totalRecogido" style="display: none;">
      üíµ Total recogido (entregados): $<span id="totalRecogidoValor">0</span>
    </div>
    
    <div id="listaPedidos">
      <div class="empty-state" id="emptyState">
        <p>No hay pedidos a√∫n</p>
        <p style="font-size: 14px;">Pega un formato de pedido arriba para comenzar</p>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>üó∫Ô∏è Mapa de Entregas</h2>
    <div id="mapa" class="mapa-container"></div>
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
let mapa = null;
let marcadores = []; // Array de objetos {pedidoId, marker}
let rutaLayer = null; // Polyline de la ruta entre marcadores
let mapaAjustado = false; // Controla si ya se hizo el primer ajuste de zoom
let nextPedidoId = 1;

// Inicializar mapa con Leaflet
function initMap() {
  mapa = L.map('mapa').setView([4.6097, -74.0817], 12); // Bogot√° por defecto
  
  // Agregar capa de OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
  }).addTo(mapa);
  
  actualizarMarcadores();
}

// Procesar texto del pedido
function procesarPedido() {
  const texto = document.getElementById("textoPedido").value.trim();
  
  if (!texto) {
    alert("Por favor, pega el formato del pedido");
    return;
  }

  // Extraer n√∫mero de pedido (si existe al inicio)
  const numeroMatch = texto.match(/^(\d+):/);
  const numeroPedido = numeroMatch ? parseInt(numeroMatch[1]) : null;

  // Extraer direcci√≥n
  const direccionMatch = texto.match(/üìç\s*Direcci√≥n completa[^\n]*:\s*([^\n]+(?:\n[^\n]+)*?)(?=\n|$)/);
  const direccion = direccionMatch ? direccionMatch[1].trim().replace(/\n/g, ' ') : '';

  // Extraer nombre
  const nombreMatch = texto.match(/üôãüèª\s*Nombre[^\n]*:\s*([^\n]+)/);
  const nombre = nombreMatch ? nombreMatch[1].trim() : '';

  // Extraer tel√©fono
  const telefonoMatch = texto.match(/üì≤\s*N√∫mero de celular[^\n]*:\s*([^\n]+)/);
  const telefono = telefonoMatch ? telefonoMatch[1].trim().replace(/\D/g, '') : '';

  // Extraer valor (manejar comas y puntos como separadores de miles)
  const valorMatch = texto.match(/üí∞\s*Valor a pagar[^\n]*:\s*([^\n]+)/);
  let valor = valorMatch ? valorMatch[1].trim() : '0';
  // Remover comas y puntos que sean separadores de miles, pero mantener el formato num√©rico
  valor = valor.replace(/[^\d]/g, ''); // Remover todo excepto d√≠gitos
  if (!valor || valor === '') valor = '0';

  // Extraer productos
  const productoMatch = texto.match(/Producto\s*üéÅ[^\n]*:\s*([^\n]+(?:\n[^\n]+)*?)(?=\n|$)/);
  const productos = productoMatch ? productoMatch[1].trim().split('\n').filter(p => p.trim()) : [];

  // Obtener URL del mapa del campo de entrada (obligatoria)
  const mapUrl = document.getElementById("mapUrlPedido").value.trim();
  if (!mapUrl) {
    alert("Debes ingresar la URL de Google Maps del pedido para poder cargarlo.");
    return;
  }

  // Determinar ID del pedido
  let pedidoId;
  if (numeroPedido) {
    // Si el n√∫mero ya existe, usar el siguiente disponible
    if (pedidos.some(p => p.id === numeroPedido)) {
      pedidoId = Math.max(...pedidos.map(p => p.id), 0) + 1;
    } else {
      pedidoId = numeroPedido;
    }
  } else {
    pedidoId = Math.max(...pedidos.map(p => p.id), 0) + 1;
  }

  const nuevoPedido = {
    id: pedidoId,
    nombre: nombre,
    telefono: telefono,
    direccion: direccion,
    productos: productos,
    valor: valor,
    textoOriginal: texto,
    mapUrl: mapUrl, // URL del mapa asociada al pedido
    entregado: false
  };

  pedidos.push(nuevoPedido);
  guardarPedidos();
  renderPedidos();

  // Procesar URL de mapa y agregar marcador
  setTimeout(() => {
    if (!mapa) {
      console.error('El mapa a√∫n no est√° inicializado');
      alert('El mapa no est√° listo. Por favor, espera un momento e intenta nuevamente.');
      return;
    }
    procesarURLMapaPedido(mapUrl, pedidoId, productos, () => {
      ajustarVistaMapa();
      dibujarRutaEntreMarcadores();
    });
  }, 500);

  // Limpiar campos
  document.getElementById("textoPedido").value = "";
  document.getElementById("mapUrlPedido").value = "";
  
  alert(`Pedido #${pedidoId} agregado exitosamente`);
}

function guardarPedidos() {
  localStorage.setItem("pedidos", JSON.stringify(pedidos));
}

function renderPedidos() {
  const lista = document.getElementById("listaPedidos");
  const emptyState = document.getElementById("emptyState");
  
  if (pedidos.length === 0) {
    lista.innerHTML = '<div class="empty-state" id="emptyState"><p>No hay pedidos a√∫n</p><p style="font-size: 14px;">Pega un formato de pedido arriba para comenzar</p></div>';
    return;
  }

  lista.innerHTML = "";

  // Ordenar: pedidos no entregados primero, entregados al final
  const pedidosOrdenados = [...pedidos].sort((a, b) => {
    const aEntregado = a.entregado ? 1 : 0;
    const bEntregado = b.entregado ? 1 : 0;
    return aEntregado - bEntregado;
  });
  
  pedidosOrdenados.forEach((pedido, indexOrdenado) => {
    const index = pedidos.indexOf(pedido);
    const div = document.createElement("div");
    div.className = "pedido" + (pedido.entregado ? " entregado" : "");
    div.draggable = !pedido.entregado;
    div.dataset.index = index;
    div.dataset.id = pedido.id;
    
    // Limpiar n√∫mero de tel√©fono para WhatsApp (solo n√∫meros)
    const telefonoLimpio = pedido.telefono ? pedido.telefono.replace(/\D/g, '') : '';
    
    const valorFormato = parseInt(pedido.valor || 0).toLocaleString('es-CO');
    const btnNoEntregadoHtml = pedido.entregado ? `<div class="pedido-no-entregado-wrap"><button class="btn-warning" onclick="marcarNoEntregado(${index})" style="width: 100%;">‚Ü©Ô∏è No entregado</button></div>` : '';
    
    div.innerHTML = `
      <div class="pedido-header">
        <div class="pedido-numero">Pedido #${pedido.id}${pedido.entregado ? ' ‚úì Entregado' : ''}</div>
        <button class="btn-danger" onclick="eliminarPedido(${index})" style="padding: 5px 10px; font-size: 12px;">‚úï Eliminar</button>
      </div>
      <div class="pedido-info">
        <strong>üë§ Nombre:</strong> ${pedido.nombre || 'No especificado'}<br>
        <strong>üìû Tel√©fono:</strong> ${pedido.telefono || 'No especificado'}<br>
        <strong>üìç Direcci√≥n:</strong> ${pedido.direccion || 'No especificada'}<br>
        <strong>üéÅ Productos:</strong> ${pedido.productos && pedido.productos.length > 0 ? pedido.productos.join(', ') : 'No especificado'}<br>
        <strong>üí∞ Valor:</strong> $${valorFormato}<br>
      </div>
      <div class="pedido-buttons">
        <button class="btn-success" onclick="whatsappLlamar('${telefonoLimpio}')">üìû WhatsApp Llamar</button>
        <button class="btn-success" onclick="whatsappMensaje('${telefonoLimpio}')">üí¨ WhatsApp Mensaje</button>
        <button class="btn-info" onclick="llamar('${telefonoLimpio}')">üì± Llamar Normal</button>
      </div>
      <div class="pedido-actions">
        <div class="pedido-actions-row">
          <button class="btn-camera" onclick="fotoEntregado(${index}, ${pedido.id})">‚úÖ Foto Entregado</button>
          <button class="btn-camera" onclick="fotoNoEntregado(${index}, ${pedido.id})">‚ùå Foto No Entregado</button>
        </div>
        <div class="pedido-actions-row">
          <button class="btn-route" onclick="enrutarConMaps(${index}, ${pedido.id})">üó∫Ô∏è Maps</button>
          <button class="btn-route" onclick="enrutarConWaze(${index}, ${pedido.id})">üìç Waze</button>
          <button class="btn-notify" onclick="notificarEnCamino(${index}, ${pedido.id})">üì¢ Notificar en Camino</button>
        </div>
      </div>
      ${btnNoEntregadoHtml}
    `;
    
    // Eventos de drag and drop
    div.addEventListener('dragstart', handleDragStart);
    div.addEventListener('dragover', handleDragOver);
    div.addEventListener('drop', handleDrop);
    div.addEventListener('dragend', handleDragEnd);
    
    lista.appendChild(div);
  });

  // Actualizar total recogido (suma de valores de pedidos entregados)
  const totalRecogido = pedidos.filter(p => p.entregado).reduce((sum, p) => sum + parseInt(p.valor || 0, 10), 0);
  const elTotal = document.getElementById('totalRecogido');
  const elValor = document.getElementById('totalRecogidoValor');
  if (elTotal && elValor) {
    elValor.textContent = totalRecogido.toLocaleString('es-CO');
    elTotal.style.display = totalRecogido > 0 ? 'block' : 'none';
  }
}

// Drag and Drop
let draggedElement = null;

function handleDragStart(e) {
  draggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  
  if (draggedElement !== this) {
    const draggedIndex = parseInt(draggedElement.dataset.index);
    const targetIndex = parseInt(this.dataset.index);
    
    // Reordenar array
    const [removed] = pedidos.splice(draggedIndex, 1);
    pedidos.splice(targetIndex, 0, removed);
    
  guardarPedidos();
  renderPedidos();
    actualizarMarcadores();
  }
  
  return false;
}

function handleDragEnd(e) {
  this.classList.remove('dragging');
}

function eliminarPedido(index) {
  if (confirm(`¬øEst√°s seguro de eliminar el pedido #${pedidos[index].id}?`)) {
    pedidos.splice(index, 1);
  guardarPedidos();
  renderPedidos();
    actualizarMarcadores();
  }
}

function marcarEntregado(index) {
  const pedido = pedidos[index];
  if (!pedido) return;
  pedido.entregado = true;
  // Mover al final de la lista
  pedidos.splice(index, 1);
  pedidos.push(pedido);
  guardarPedidos();
  renderPedidos();
  actualizarMarcadores();
}

function marcarNoEntregado(index) {
  const pedido = pedidos[index];
  if (!pedido) return;
  pedido.entregado = false;
  // Mover al inicio (quitar de donde est√° y poner al principio de los no entregados)
  pedidos.splice(index, 1);
  pedidos.unshift(pedido);
  guardarPedidos();
  renderPedidos();
  actualizarMarcadores();
}

function eliminarTodos() {
  if (confirm("¬øEst√°s seguro de eliminar TODOS los pedidos? Esta acci√≥n no se puede deshacer.")) {
  pedidos = [];
  guardarPedidos();
  renderPedidos();
    actualizarMarcadores();
  }
}

function llamar(numero) {
  if (!numero) {
    alert("No hay n√∫mero de tel√©fono disponible");
    return;
  }
  // Limpiar n√∫mero (solo d√≠gitos)
  const numeroLimpio = numero.toString().replace(/\D/g, '');
  if (!numeroLimpio) {
    alert("N√∫mero de tel√©fono inv√°lido");
    return;
  }
  window.location.href = `tel:${numeroLimpio}`;
}

function whatsappLlamar(numero) {
  if (!numero) {
    alert("No hay n√∫mero de tel√©fono disponible");
    return;
  }
  // Limpiar n√∫mero (solo d√≠gitos)
  const numeroLimpio = numero.toString().replace(/\D/g, '');
  if (!numeroLimpio) {
    alert("N√∫mero de tel√©fono inv√°lido");
    return;
  }
  // WhatsApp requiere c√≥digo de pa√≠s, si no tiene, asumir Colombia (57)
  const numeroWhatsApp = numeroLimpio.startsWith('57') ? numeroLimpio : `57${numeroLimpio}`;
  window.open(`https://wa.me/${numeroWhatsApp}`, "_blank");
}

function whatsappMensaje(numero) {
  if (!numero) {
    alert("No hay n√∫mero de tel√©fono disponible");
    return;
  }
  // Limpiar n√∫mero (solo d√≠gitos)
  const numeroLimpio = numero.toString().replace(/\D/g, '');
  if (!numeroLimpio) {
    alert("N√∫mero de tel√©fono inv√°lido");
    return;
  }
  // WhatsApp requiere c√≥digo de pa√≠s, si no tiene, asumir Colombia (57)
  const numeroWhatsApp = numeroLimpio.startsWith('57') ? numeroLimpio : `57${numeroLimpio}`;
  window.open(`https://wa.me/${numeroWhatsApp}?text=Hola`, "_blank");
}

// Variables para manejar el estado de la foto
let fotoEstado = null; // 'entregado' o 'noEntregado'
let fotoPedidoIndex = null;
let fotoPedidoId = null;

// Foto Entregado: abre WhatsApp con mensaje y marca el pedido como entregado (al final, en gris)
function fotoEntregado(index, pedidoId) {
  const numeroAdmin = '573143473582';
  const mensaje = `Pedido #${pedidoId} entregado`;
  window.open(`https://wa.me/${numeroAdmin}?text=${encodeURIComponent(mensaje)}`, '_blank');
  marcarEntregado(index);
}

// Foto No Entregado: abre WhatsApp con mensaje y marca el pedido como entregado (al final, en gris)
function fotoNoEntregado(index, pedidoId) {
  const numeroAdmin = '573143473582';
  const mensaje = `Pedido #${pedidoId} no entregado`;
  window.open(`https://wa.me/${numeroAdmin}?text=${encodeURIComponent(mensaje)}`, '_blank');
  marcarEntregado(index);
}

// Procesar foto y enviar por WhatsApp
function procesarFoto(event, index, pedidoId) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const imageData = e.target.result;
    enviarFotoPorWhatsApp(imageData, pedidoId);
  };
  reader.readAsDataURL(file);
  
  // Limpiar el input para poder tomar otra foto
  event.target.value = '';
}

// Enviar foto por WhatsApp al n√∫mero de administraci√≥n
function enviarFotoPorWhatsApp(imageData, pedidoId) {
  const numeroAdmin = '573143473582'; // N√∫mero de administraci√≥n con c√≥digo de pa√≠s
  const mensaje = fotoEstado === 'entregado' 
    ? `Entregado pedido #${pedidoId}` 
    : `Pedido #${pedidoId} no entregado`;
  
  // Verificar si estamos en m√≥vil
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  
  if (isMobile && navigator.share) {
    // Usar Web Share API si est√° disponible (mejor para m√≥viles)
    // Convertir imageData a blob para compartir
    fetch(imageData)
      .then(res => res.blob())
      .then(blob => {
        const file = new File([blob], `pedido_${pedidoId}.jpg`, { type: 'image/jpeg' });
        navigator.share({
          title: mensaje,
          text: mensaje,
          files: [file]
        }).catch(err => {
          console.log('Error compartiendo:', err);
          // Fallback a WhatsApp
          abrirWhatsAppConMensaje(numeroAdmin, mensaje);
        });
      })
      .catch(err => {
        console.log('Error procesando imagen:', err);
        abrirWhatsAppConMensaje(numeroAdmin, mensaje);
      });
  } else {
    // Para desktop o navegadores sin Web Share API
    abrirWhatsAppConMensaje(numeroAdmin, mensaje);
  }
}

// Funci√≥n auxiliar para abrir WhatsApp con mensaje
function abrirWhatsAppConMensaje(numero, mensaje) {
  const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensaje)}`;
  window.open(url, '_blank');
  
  // Mostrar instrucciones
  setTimeout(() => {
    alert(`Se abrir√° WhatsApp.\n\nPor favor:\n1. Adjunta la foto que acabas de tomar\n2. El mensaje ya est√° escrito: "${mensaje}"\n\nMensaje: ${mensaje}`);
  }, 500);
}

// Obtener ubicaci√≥n del pedido (coordenadas o direcci√≥n)
function getUbicacionPedido(index, pedidoId) {
  const pedido = pedidos[index];
  if (!pedido) return null;
  let lat = null, lng = null;
  const marcadorPedido = marcadores.find(m => m.pedidoId === pedidoId);
  if (marcadorPedido && marcadorPedido.marker) {
    const pos = marcadorPedido.marker.getLatLng();
    lat = pos.lat;
    lng = pos.lng;
  }
  if ((!lat || !lng) && pedido.mapUrl) {
    const match = pedido.mapUrl.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
    if (match) {
      lat = parseFloat(match[1]);
      lng = parseFloat(match[2]);
    }
  }
  if (lat != null && lng != null) return { lat, lng };
  if (pedido.direccion) return { direccion: pedido.direccion };
  return null;
}

// Abrir solo Google Maps
function enrutarConMaps(index, pedidoId) {
  const u = getUbicacionPedido(index, pedidoId);
  if (!u) {
    alert('No hay ubicaci√≥n disponible para este pedido. Agrega una URL de Google Maps.');
    return;
  }
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
  const isAndroid = /Android/.test(navigator.userAgent);
  if (u.lat != null && u.lng != null) {
    if (isIOS) {
      window.location.href = `maps://maps.google.com/maps?daddr=${u.lat},${u.lng}&directionsmode=driving`;
      setTimeout(() => window.open(`https://www.google.com/maps/dir/?api=1&destination=${u.lat},${u.lng}&travelmode=driving`, '_blank'), 1000);
    } else if (isAndroid) {
      window.location.href = `google.navigation:q=${u.lat},${u.lng}`;
      setTimeout(() => window.open(`https://www.google.com/maps/dir/?api=1&destination=${u.lat},${u.lng}&travelmode=driving`, '_blank'), 1000);
    } else {
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${u.lat},${u.lng}&travelmode=driving`, '_blank');
    }
  } else {
    const dest = encodeURIComponent(u.direccion);
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${dest}&travelmode=driving`, '_blank');
  }
}

// Abrir solo Waze
function enrutarConWaze(index, pedidoId) {
  const u = getUbicacionPedido(index, pedidoId);
  if (!u) {
    alert('No hay ubicaci√≥n disponible para este pedido. Agrega una URL de Google Maps.');
    return;
  }
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  if (u.lat != null && u.lng != null) {
    if (isMobile) {
      window.location.href = `waze://?ll=${u.lat},${u.lng}&navigate=yes`;
      setTimeout(() => window.open(`https://waze.com/ul?ll=${u.lat},${u.lng}&navigate=yes`, '_blank'), 1000);
    } else {
      window.open(`https://waze.com/ul?ll=${u.lat},${u.lng}&navigate=yes`, '_blank');
    }
  } else {
    const q = encodeURIComponent(u.direccion);
    if (isMobile) {
      window.location.href = `waze://?q=${q}&navigate=yes`;
      setTimeout(() => window.open(`https://waze.com/ul?q=${q}&navigate=yes`, '_blank'), 1000);
    } else {
      window.open(`https://waze.com/ul?q=${q}&navigate=yes`, '_blank');
    }
  }
}

// Funci√≥n para notificar al cliente que el repartidor va en camino
function notificarEnCamino(index, pedidoId) {
  const pedido = pedidos[index];
  if (!pedido) return;
  const telefonoCliente = pedido.telefono ? String(pedido.telefono).replace(/\D/g, '') : '';
  if (!telefonoCliente) {
    alert('No hay n√∫mero de tel√©fono del cliente disponible');
    return;
  }
  
  const nombre = pedido.nombre || 'cliente';
  const precio = parseInt(pedido.valor || 0, 10).toLocaleString('es-CO');
  const numeroWhatsApp = telefonoCliente.startsWith('57') ? telefonoCliente : `57${telefonoCliente}`;
  
  const mensaje = `Hola ${nombre}

Te informamos que nuestro repartidor de Valero Store se encuentra en camino hacia tu ubicaci√≥n para entregar el pedido.

Por favor ten en cuenta:
- Estar pendiente con los $${precio} en mano
- El repartidor NO CUENTA CON CAMBIO
- El tiempo de espera desde la llegada al punto de entrega es de 10 minutos

Si deseas pagar por Nequi o Daviplata, el n√∫mero es: 3143645061
Aparecer√° como Mic**** Por*******
O si gustas puedes pagar por Bre-B con la llave: @NEQUIMIC7057

Gracias por tu compra ${nombre}`;
  
  const url = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensaje)}`;
  window.open(url, '_blank');
}

// Funciones del mapa con Leaflet y Nominatim (gratuito)
function actualizarMarcadores() {
  if (!mapa) return;
  
  // Eliminar marcadores y ruta existentes
  marcadores.forEach(item => mapa.removeLayer(item.marker));
  marcadores = [];
  if (rutaLayer) {
    mapa.removeLayer(rutaLayer);
    rutaLayer = null;
  }
  
  if (pedidos.length === 0) return;
  
  // Procesar pedidos con URLs o direcciones
  let procesamientosCompletados = 0;
  const pedidosConUbicacion = pedidos.filter(p => p.mapUrl || p.direccion);
  const totalPedidos = pedidosConUbicacion.length;
  
  if (totalPedidos === 0) return;
  
  pedidosConUbicacion.forEach((pedido, index) => {
    const idPedido = pedido.id; // Capturar id del pedido (no el √≠ndice)
    const mapUrlPedido = pedido.mapUrl;
    const direccionPedido = pedido.direccion;
    const productosPedido = pedido.productos;
    setTimeout(() => {
      if (mapUrlPedido) {
        procesarURLMapaPedido(mapUrlPedido, idPedido, productosPedido, () => {
          procesamientosCompletados++;
          if (procesamientosCompletados === totalPedidos) {
            ajustarVistaMapa();
            dibujarRutaEntreMarcadores();
          }
        });
      } else if (direccionPedido) {
        geocodificarDireccion(direccionPedido, idPedido, productosPedido, () => {
          procesamientosCompletados++;
          if (procesamientosCompletados === totalPedidos) {
            ajustarVistaMapa();
            dibujarRutaEntreMarcadores();
          }
        });
      }
    }, index * 1000);
  });
}

function geocodificarDireccion(direccion, pedidoId, productos, callback) {
  // Usar Nominatim API (gratuita) para geocodificaci√≥n
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}&limit=1`;
  
  fetch(url, {
    headers: {
      'User-Agent': 'DeliveryApp/1.0'
    }
  })
    .then(response => response.json())
    .then(data => {
      if (data && data.length > 0) {
        const lat = parseFloat(data[0].lat);
        const lng = parseFloat(data[0].lon);
        
        // Crear marcador personalizado con n√∫mero de pedido (siempre el id real del pedido)
        const numPedido = Number(pedidoId);
        const iconHtml = `
          <div style="background-color: #f44336; color: white; width: 35px; height: 35px; 
                      border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                      font-weight: bold; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
            #${numPedido}
          </div>
        `;
        
        const customIcon = L.divIcon({
          html: iconHtml,
          className: 'custom-marker',
          iconSize: [35, 35],
          iconAnchor: [17, 17]
        });
        
        const marker = L.marker([lat, lng], { icon: customIcon }).addTo(mapa);
        
        // Crear popup con informaci√≥n
        const popupContent = `
          <div style="padding: 5px; min-width: 200px;">
            <h3 style="margin: 0 0 10px 0; color: #4CAF50; font-size: 16px;">Pedido #${pedidoId}</h3>
            <p style="margin: 5px 0;"><strong>Direcci√≥n:</strong> ${direccion}</p>
            <p style="margin: 5px 0;"><strong>Productos:</strong> ${productos && productos.length > 0 ? productos.join(', ') : 'No especificado'}</p>
          </div>
        `;
        
        marker.bindPopup(popupContent);
        
        // Guardar marcador con referencia al pedidoId (solo si no es temporal)
        if (pedidoId !== 'TEMP') {
          marcadores.push({ pedidoId: pedidoId, marker: marker });
        }
        
        if (callback) callback();
      } else {
        console.warn(`No se pudo geocodificar: ${direccion}`);
        if (callback) callback();
      }
    })
    .catch(error => {
      console.error('Error en geocodificaci√≥n:', error);
      if (callback) callback();
    });
}

function ajustarVistaMapa() {
  // Solo ajustar autom√°ticamente la primera vez que se cargan marcadores
  if (mapaAjustado || marcadores.length === 0) return;
  
  const markers = marcadores.map(item => item.marker);
  const group = new L.featureGroup(markers);
  mapa.fitBounds(group.getBounds().pad(0.1));
  
  // Ajustar zoom si hay solo un marcador
  if (marcadores.length === 1) {
    mapa.setZoom(15);
  }
  
  mapaAjustado = true;
}

// Dibujar ruta entre marcadores (orden de la lista de pedidos)
function dibujarRutaEntreMarcadores() {
  if (!mapa || marcadores.length < 2) return;
  
  // Quitar ruta anterior
  if (rutaLayer) {
    mapa.removeLayer(rutaLayer);
    rutaLayer = null;
  }
  
  // Obtener coordenadas en el orden de pedidos
  const coordenadas = [];
  for (let i = 0; i < pedidos.length; i++) {
    const p = pedidos[i];
    const item = marcadores.find(m => m.pedidoId === p.id);
    if (item && item.marker) {
      const latlng = item.marker.getLatLng();
      coordenadas.push([latlng.lng, latlng.lat]); // OSRM usa lng,lat
    }
  }
  
  if (coordenadas.length < 2) return;
  
  const coordsStr = coordenadas.map(c => c.join(',')).join(';');
  const url = `https://router.project-osrm.org/route/v1/driving/${coordsStr}?overview=full&geometries=geojson`;
  
  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data.code !== 'Ok' || !data.routes || !data.routes[0]) return;
      const geom = data.routes[0].geometry;
      if (!geom || !geom.coordinates) return;
      // coordinates es [[lng,lat],[lng,lat],...]
      const latlngs = geom.coordinates.map(c => [c[1], c[0]]);
      rutaLayer = L.polyline(latlngs, {
        color: '#2196F3',
        weight: 5,
        opacity: 0.7
      }).addTo(mapa);
    })
    .catch(() => {
      // Fallback: l√≠nea recta entre puntos
      const latlngs = coordenadas.map(c => [c[1], c[0]]);
      rutaLayer = L.polyline(latlngs, {
        color: '#2196F3',
        weight: 4,
        opacity: 0.6,
        dashArray: '10, 10'
      }).addTo(mapa);
    });
}

// Procesar URL de mapa para un pedido espec√≠fico (marcador permanente)
function procesarURLMapaPedido(url, pedidoId, productos, callback) {
  if (!mapa) {
    console.error('El mapa no est√° inicializado');
    if (callback) callback();
    return;
  }
  
  // Extraer coordenadas de diferentes formatos de URL de Google Maps
  let lat, lng;
  
  console.log('Intentando extraer coordenadas de URL:', url);
  
  // Formato 1: https://www.google.com/maps/@lat,lng,zoom
  const match1 = url.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if (match1) {
    lat = parseFloat(match1[1]);
    lng = parseFloat(match1[2]);
    console.log('Formato 1 detectado (@lat,lng):', lat, lng);
  } else {
    // Formato 2: https://www.google.com/maps/place/.../@lat,lng
    const match2 = url.match(/place\/[^@]+@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
    if (match2) {
      lat = parseFloat(match2[1]);
      lng = parseFloat(match2[2]);
      console.log('Formato 2 detectado (place/.../@lat,lng):', lat, lng);
    } else {
      // Formato 3: https://maps.google.com/?q=lat,lng
      const match3 = url.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
      if (match3) {
        lat = parseFloat(match3[1]);
        lng = parseFloat(match3[2]);
        console.log('Formato 3 detectado (?q=lat,lng):', lat, lng);
      } else {
        // Formato 4: https://www.google.com/maps/search/?api=1&query=lat,lng
        const match4 = url.match(/query=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
        if (match4) {
          lat = parseFloat(match4[1]);
          lng = parseFloat(match4[2]);
          console.log('Formato 4 detectado (query=lat,lng):', lat, lng);
        } else {
          // Formato 5: https://www.google.com/maps?ll=lat,lng
          const match5 = url.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
          if (match5) {
            lat = parseFloat(match5[1]);
            lng = parseFloat(match5[2]);
            console.log('Formato 5 detectado (ll=lat,lng):', lat, lng);
          } else {
            // Formato 6: Coordenadas directas en el texto (lat, lng) o (lat,lng)
            const match6 = url.match(/(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)/);
            if (match6) {
              lat = parseFloat(match6[1]);
              lng = parseFloat(match6[2]);
              console.log('Formato 6 detectado (coordenadas directas):', lat, lng);
            } else {
              // Si no es una URL con coordenadas, tratar como direcci√≥n y geocodificar
              console.log('No se encontraron coordenadas en la URL, intentando geocodificar como direcci√≥n...');
              geocodificarDireccion(url, pedidoId, productos || [], callback);
              return;
            }
          }
        }
      }
    }
  }
  
  // Validar coordenadas
  if (isNaN(lat) || isNaN(lng)) {
    console.error('Coordenadas inv√°lidas (NaN):', lat, lng, 'URL:', url);
    alert(`No se pudieron extraer coordenadas v√°lidas de la URL para el pedido #${pedidoId}.\n\nURL ingresada: ${url}\n\nAseg√∫rate de usar una URL completa de Google Maps que incluya las coordenadas.`);
    if (callback) callback();
    return;
  }
  
  // Verificar que las coordenadas est√©n en un rango v√°lido (permitir lat=0 o lng=0 si est√°n cerca del ecuador/meridiano)
  if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
    console.error('Coordenadas fuera de rango:', lat, lng);
    alert(`Las coordenadas extra√≠das est√°n fuera de rango v√°lido para el pedido #${pedidoId}.\n\nLatitud: ${lat}, Longitud: ${lng}`);
    if (callback) callback();
    return;
  }
  
  console.log(`Procesando URL para pedido #${pedidoId}:`, url);
  console.log(`Coordenadas extra√≠das: lat=${lat}, lng=${lng}`);
  
  // Crear marcador permanente con n√∫mero de pedido (siempre el id real: 1, 2, 3, 4, 11, 52...)
  const numPedido = Number(pedidoId);
  const iconHtml = `
    <div style="background-color: #f44336; color: white; width: 35px; height: 35px; 
                border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                font-weight: bold; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
      #${numPedido}
    </div>
  `;
  
  const customIcon = L.divIcon({
    html: iconHtml,
    className: 'custom-marker',
    iconSize: [35, 35],
    iconAnchor: [17, 17]
  });
  
  try {
    const marker = L.marker([lat, lng], { icon: customIcon });
    marker.addTo(mapa);
    
    // Crear popup con informaci√≥n
    const popupContent = `
      <div style="padding: 5px; min-width: 200px;">
        <h3 style="margin: 0 0 10px 0; color: #4CAF50; font-size: 16px;">Pedido #${pedidoId}</h3>
        <p style="margin: 5px 0;"><strong>Productos:</strong> ${productos && productos.length > 0 ? productos.join(', ') : 'No especificado'}</p>
      </div>
    `;
    
    marker.bindPopup(popupContent);
    
    // Guardar marcador permanente con referencia al pedidoId
    marcadores.push({ pedidoId: pedidoId, marker: marker });
    
    console.log(`‚úì Marcador agregado exitosamente para pedido #${pedidoId} en coordenadas: ${lat}, ${lng}`);
    console.log(`Total de marcadores: ${marcadores.length}`);
    
    if (callback) callback();
  } catch (error) {
    console.error('Error al agregar marcador:', error);
    alert(`Error al agregar marcador para el pedido #${pedidoId}: ${error.message}`);
    if (callback) callback();
  }
}

// Funciones de sincronizaci√≥n entre dispositivos
function exportarDatos() {
  if (pedidos.length === 0) {
    alert('No hay pedidos para exportar');
    return;
  }
  
  const datos = {
    pedidos: pedidos,
    timestamp: new Date().toISOString(),
    version: '1.0'
  };
  
  const datosJSON = JSON.stringify(datos);
  const datosCodificados = btoa(unescape(encodeURIComponent(datosJSON)));
  
  // Crear enlace compartible
  const urlCompartir = window.location.origin + window.location.pathname + '?data=' + encodeURIComponent(datosCodificados);
  
  // Mostrar el c√≥digo en el textarea
  const syncArea = document.getElementById('syncCodeArea');
  const syncData = document.getElementById('syncData');
  syncArea.style.display = 'block';
  syncData.value = datosCodificados;
  syncData.select();
  
  // Generar QR
  mostrarQR(datosCodificados);
  
  // Mostrar enlace compartible
  const infoDiv = document.querySelector('.sync-info');
  if (infoDiv) {
    infoDiv.innerHTML = `
      <strong>Opciones de sincronizaci√≥n:</strong><br>
      1. Escanea el c√≥digo QR con tu celular<br>
      2. Copia el c√≥digo de texto y p√©galo en tu celular<br>
      3. Comparte este enlace: <a href="${urlCompartir}" target="_blank" style="word-break: break-all; color: #2196F3;">${urlCompartir.substring(0, 50)}...</a><br><br>
      <strong>Total de pedidos:</strong> ${pedidos.length}
    `;
  }
  
  // Copiar c√≥digo al portapapeles si es posible
  if (navigator.clipboard) {
    navigator.clipboard.writeText(datosCodificados).then(() => {
      // Tambi√©n intentar copiar el enlace
      navigator.clipboard.writeText(urlCompartir).catch(() => {});
    }).catch(() => {});
  }
}

function importarDatos() {
  const syncArea = document.getElementById('syncCodeArea');
  syncArea.style.display = 'block';
  document.getElementById('syncData').focus();
}

function aplicarImportacion() {
  const datosCodificados = document.getElementById('syncData').value.trim();
  
  if (!datosCodificados) {
    alert('Por favor, pega el c√≥digo de sincronizaci√≥n');
    return;
  }
  
  try {
    // Decodificar datos
    const datosJSON = decodeURIComponent(escape(atob(datosCodificados)));
    const datos = JSON.parse(datosJSON);
    
    if (!datos.pedidos || !Array.isArray(datos.pedidos)) {
      throw new Error('Formato de datos inv√°lido');
    }
    
    // Confirmar antes de sobrescribir
    const confirmar = confirm(
      `¬øImportar ${datos.pedidos.length} pedido(s)?\n\nEsto reemplazar√° todos los pedidos actuales.`
    );
    
    if (!confirmar) return;
    
    // Importar pedidos
    pedidos = datos.pedidos;
    
    // Asegurar que todos tengan mapUrl y entregado
    pedidos = pedidos.map(pedido => {
      if (!pedido.hasOwnProperty('mapUrl')) pedido.mapUrl = '';
      if (!pedido.hasOwnProperty('entregado')) pedido.entregado = false;
      return pedido;
    });
    
    guardarPedidos();
    renderPedidos();
    
    // Actualizar marcadores despu√©s de un momento
    setTimeout(() => {
      actualizarMarcadores();
    }, 500);
    
    // Ocultar √°rea de sincronizaci√≥n
    document.getElementById('syncCodeArea').style.display = 'none';
    document.getElementById('qrContainer').style.display = 'none';
    document.getElementById('syncData').value = '';
    
    alert(`‚úÖ ${pedidos.length} pedido(s) importado(s) exitosamente!`);
    
  } catch (error) {
    console.error('Error al importar:', error);
    alert('‚ùå Error al importar datos. Verifica que el c√≥digo sea correcto.\n\nError: ' + error.message);
  }
}

function mostrarQR(datosCodificados) {
  const qrContainer = document.getElementById('qrContainer');
  const canvas = document.getElementById('qrCode');
  
  // Si no se pasan datos, usar los datos actuales
  if (!datosCodificados) {
    if (pedidos.length === 0) {
      alert('No hay pedidos para generar QR');
      return;
    }
    const datos = {
      pedidos: pedidos,
      timestamp: new Date().toISOString(),
      version: '1.0'
    };
    const datosJSON = JSON.stringify(datos);
    datosCodificados = btoa(unescape(encodeURIComponent(datosJSON)));
  }
  
  qrContainer.style.display = 'block';
  
  // Limpiar canvas anterior
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Ajustar tama√±o del canvas seg√∫n el dispositivo
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  const qrSize = isMobile ? 250 : 300;
  
  canvas.width = qrSize;
  canvas.height = qrSize;
  
  // Generar QR code
  QRCode.toCanvas(canvas, datosCodificados, {
    width: qrSize,
    margin: 2,
    color: {
      dark: '#000000',
      light: '#FFFFFF'
    }
  }, function (error) {
    if (error) {
      console.error('Error generando QR:', error);
      qrContainer.innerHTML = '<p style="color: red; padding: 20px;">Error al generar c√≥digo QR. Usa el c√≥digo de texto en su lugar.</p>';
    }
  });
}

// Funci√≥n para detectar si hay datos en la URL (para compartir f√°cilmente)
function verificarDatosEnURL() {
  const urlParams = new URLSearchParams(window.location.search);
  const datosURL = urlParams.get('data');
  
  if (datosURL) {
    const confirmar = confirm('¬øImportar datos desde el enlace compartido?');
    if (confirmar) {
      document.getElementById('syncData').value = datosURL;
      aplicarImportacion();
      // Limpiar URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  }
}

// Inicializar cuando carga la p√°gina
window.onload = function() {
  // Cargar pedidos guardados y asegurar que tengan el campo mapUrl
  pedidos = pedidos.map(pedido => {
    if (!pedido.hasOwnProperty('mapUrl')) pedido.mapUrl = '';
    if (!pedido.hasOwnProperty('entregado')) pedido.entregado = false;
    return pedido;
  });
  guardarPedidos();
  
  if (pedidos.length > 0) {
    nextPedidoId = Math.max(...pedidos.map(p => p.id)) + 1;
  }
  
  renderPedidos();
  
  // Inicializar mapa con Leaflet (completamente gratuito)
  initMap();
  
  // Verificar si hay datos en la URL para importar
  verificarDatosEnURL();
};
</script>

</body>
</html>